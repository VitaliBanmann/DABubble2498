<main class="home-page">
    <header class="home-header">
        <div>
            <h1>{{ isDirectMessage ? '@ ' + currentConversationTitle : '# ' + currentConversationTitle }}</h1>
            <p>
                {{
                    isDirectMessage
                        ? 'Direktnachricht'
                        : 'Channel'
                }}
            </p>
        </div>

        @if (!isDirectMessage) {
            <button type="button" class="thread-btn" (click)="openThread()">
                Thread Ã¶ffnen
            </button>
        }
    </header>

    <section class="message-list" aria-label="Nachrichtenliste">
        @if (!messages.length) {
            <p class="empty-state">Noch keine Nachrichten in diesem Channel.</p>
        }

        @for (message of messages; track message.id ?? $index) {
            <article class="message" [class.own]="isOwnMessage(message)">
                <div class="message__meta">
                    <span>{{ getSenderLabel(message) }}</span>
                    <span>{{ formatTimestamp(message.timestamp) }}</span>
                </div>
                <p>{{ message.text }}</p>

                @if (message.reactions?.length) {
                    <div class="message__reactions">
                        @for (
                            reaction of getVisibleReactions(message);
                            track reaction.emoji
                        ) {
                            <button
                                type="button"
                                class="reaction"
                                [class.active]="hasCurrentUserReacted(reaction)"
                                (click)="toggleReaction(message, reaction.emoji)"
                            >
                                <span>{{ reaction.emoji }}</span>
                                <span>{{ reaction.userIds.length }}</span>
                            </button>
                        }

                        @if (getHiddenReactionCount(message) > 0) {
                            <button
                                type="button"
                                class="reaction more"
                                (click)="toggleReactionList(message)"
                            >
                                +{{ getHiddenReactionCount(message) }} weitere
                            </button>
                        } @else if ((message.reactions?.length ?? 0) > 20) {
                            <button
                                type="button"
                                class="reaction more"
                                (click)="toggleReactionList(message)"
                            >
                                weniger anzeigen
                            </button>
                        }
                    </div>
                }
            </article>
        }
    </section>

    <form class="composer" (ngSubmit)="sendMessage()">
        <input
            type="text"
            [formControl]="messageControl"
            [placeholder]="isDirectMessage ? 'Nachricht an ' + currentConversationTitle : 'Nachricht schreiben...'"
            [disabled]="isSending || !canWrite"
        />

        <button
            type="submit"
            [disabled]="isSending || !messageControl.value.trim() || !canWrite"
        >
            {{ isSending ? 'Sende...' : 'Senden' }}
        </button>
    </form>

    @if (!canWrite) {
        <p class="hint">Als Gast kannst du Nachrichten lesen, aber nicht senden.</p>
    }

    @if (errorMessage) {
        <p class="error">{{ errorMessage }}</p>
    }
</main>
